<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="brand">
        <img src="assets/lr.jpeg" alt="LeaseRight Logo" class="logo">
        <h1>Lease Request</h1>
      </div>
      <div class="user-section">
        <app-profile-dropdown
          [userName]="userName"
          [userRole]="'Vendor Dashboard'"
          [menuItems]="profileMenuItems"
          (menuItemClick)="onProfileMenuClick($event)"
          (logoutClick)="logout()">
        </app-profile-dropdown>
      </div>
    </div>
  </header>

  <!-- Account Details Section -->
  <div class="dashboard-main" *ngIf="showAccountDetails">
    <app-account-details [userRole]="'vendor'"></app-account-details>
    <div style="text-align: center; margin-top: 20px;">
      <button class="action-btn vendor" (click)="closeAccountDetails()">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      </button>
    </div>
  </div>

  <!-- My Vehicles Section -->
  <div class="dashboard-main" *ngIf="showMyVehicles">
    <div class="vehicles-section">
      <div class="section-header">
        <h3><i class="fas fa-car"></i> My Vehicles ({{ myVehicles.length }})</h3>
        <button class="btn-close" (click)="closeMyVehicles()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="vehicles-grid" *ngIf="myVehicles.length > 0">
        <div class="vehicle-card" *ngFor="let vehicle of myVehicles">
          <div class="vehicle-header">
            <h4>{{ vehicle.licensePlate || 'Registration N/A' }}</h4>
            <span class="vehicle-type">{{ vehicle.brandName }} {{ vehicle.brandModel }}</span>
          </div>
          <div class="vehicle-info">
            <div class="detail-item">
              <span class="label">Fuel:</span>
              <span class="value">{{ vehicle.fuelType || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Insurance Expiry:</span>
              <span class="value">{{ vehicle.insuranceExpiry || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Seating Capacity:</span>
              <span class="value">{{ vehicle.seatingCapacity || 'N/A' }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <p class="no-data" *ngIf="myVehicles.length === 0">
        <i class="fas fa-info-circle"></i>
        No vehicles added yet. Add your first vehicle to start receiving lease requests.
      </p>
      
      <div style="text-align: center; margin-top: 20px;">
        <button class="action-btn vendor" (click)="toggleAddVehicleSection()">
          <i class="fas fa-plus"></i>
          Add New Vehicle
        </button>
      </div>
    </div>
  </div>

  <!-- My Quotes Section -->
  <div class="dashboard-main" *ngIf="showMyQuotes">
    <div class="requests-section">
      <div class="section-header">
        <h3><i class="fas fa-file-invoice-dollar"></i> My Quotations</h3>
        <button class="btn-close" (click)="closeMyQuotes()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <p class="no-data">
        <i class="fas fa-info-circle"></i>
        Your submitted quotations will appear here.
      </p>
    </div>
  </div>

  <!-- Main Content -->
  <main class="dashboard-main" *ngIf="!showAccountDetails && !showMyVehicles && !showMyQuotes">
    <div class="welcome-section">
      <h2>Welcome back, {{ userName }}! ðŸ‘‹</h2>
      <p>Manage your vehicle inventory and lease requests</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-car"></i>
        </div>
        <div class="stat-details">
          <h3>Total Vehicles</h3>
          <p class="stat-number">{{ stats.totalVehicles }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-details">
          <h3>Approved Requests</h3>
          <p class="stat-number">{{ stats.approvedRequests }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-details">
          <h3>Pending Requests</h3>
          <p class="stat-number">{{ stats.pendingRequests }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-details">
          <h3>Monthly Revenue</h3>
          <p class="stat-number">${{ stats.totalRevenue }}</p>
        </div>
      </div>
    </div>
 
    <!-- Quick Actions -->
    <div class="actions-section">
      <div class="actions-grid">
        <button class="action-btn" type="button" (click)="openIncomingRequestsQuickAction()">
          <i class="fas fa-inbox"></i>
          Incoming Lease Requests
          <i class="fas" [ngClass]="{ 'fa-chevron-down': !showIncomingRequestsSection, 'fa-chevron-up': showIncomingRequestsSection }"></i>
        </button>
        <button class="action-btn" type="button" (click)="openAddVehicleQuickAction()">
          <i class="fas fa-car-side"></i>
          Add New Vehicle
        </button>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="alert alert-success" *ngIf="successMessage && !showResponseForm">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>
    <div class="alert alert-error" *ngIf="errorMessage && !showResponseForm">
      <i class="fas fa-exclamation-circle"></i>
      {{ errorMessage }}
    </div>

    <!-- Incoming Lease Requests -->
    <div class="requests-section" id="incoming-requests" *ngIf="showIncomingRequestsSection">
      <h3>Incoming Lease Requests ({{ pendingRequests.length }})</h3>
      
      <div class="requests-grid" *ngIf="pendingRequests.length > 0">
        <div class="request-card" *ngFor="let request of pendingRequests">
          <div class="request-header">
            <div>
              <h4>{{ request.vehicleType }}<span *ngIf="request.preferredModel"> - {{ request.preferredModel }}</span></h4>
              <p class="company-name">{{ request.companyName }}</p>
            </div>
            <span class="request-date">{{ request.createdAt | date:'short' }}</span>
          </div>
          
          <div class="request-details">
            <div class="detail-item" *ngIf="request.companyEmail">
              <i class="fas fa-envelope"></i>
              <span>{{ request.companyEmail }}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-calendar"></i>
              <span>Duration: {{ request.leaseDuration }} {{ request.leaseDuration === 1 ? 'month' : 'months' }}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-rupee-sign"></i>
              <span>Budget: â‚¹{{ request.minBudget | number }} - â‚¹{{ request.maxBudget | number }}/month</span>
            </div>
          </div>
          
          <div class="request-description" *ngIf="request.additionalRequirements">
            <strong>Requirements:</strong>
            <p>{{ request.additionalRequirements }}</p>
          </div>
          
          <button class="btn-respond" (click)="respondToRequest(request)">
            <i class="fas fa-reply"></i>
            Respond to Request
          </button>
        </div>
      </div>
      
      <p class="no-data" *ngIf="pendingRequests.length === 0">
        <i class="fas fa-info-circle"></i>
        No pending lease requests at the moment.
      </p>
    </div>

    <!-- Add New Vehicle Section -->
    <div class="requests-section add-vehicle-section" id="add-vehicle-section" *ngIf="showAddVehicleSection">
      <div class="add-vehicle-header" (click)="toggleAddVehicleSection()">
        <h3>Add New Vehicle</h3>
        <button class="add-toggle-btn" type="button">
          <i class="fas" [ngClass]="{ 'fa-chevron-down': !showAddVehicleSection, 'fa-chevron-up': showAddVehicleSection }"></i>
        </button>
      </div>

      <div class="add-vehicle-body" *ngIf="showAddVehicleSection">
        <div class="add-vehicle-grid">
          <div class="form-group">
            <label>Vehicle Number</label>
            <input class="form-input" [(ngModel)]="newVehicleNumber" placeholder="Enter registration number" />
          </div>
          <div class="form-group">
            <label>Owner Name</label>
            <input class="form-input" [(ngModel)]="newOwnerName" placeholder="Enter owner name" />
          </div>
        </div>

        <button class="btn-respond" type="button" (click)="fetchVehicleDetails()">
          <i [class]="lookupLoading ? 'fas fa-spinner fa-spin' : 'fas fa-search' "></i>
          {{ lookupLoading ? 'Fetching details...' : 'Fetch Vehicle Details' }}
        </button>

        <div class="inline-error" *ngIf="lookupError">
          <i class="fas fa-exclamation-circle"></i>
          {{ lookupError }}
        </div>

        <div class="request-description" *ngIf="lookedUpVehicle">
          <strong>Vehicle Details (editable)</strong>
          <div class="add-vehicle-grid">
            <div class="form-group">
              <label>Registration Number</label>
              <input class="form-input" [(ngModel)]="lookedUpVehicle.registrationNumber" />
            </div>
            <div class="form-group">
              <label>Owner Name</label>
              <input class="form-input" [(ngModel)]="lookedUpVehicle.ownerName" />
            </div>
            <div class="form-group">
              <label>Make</label>
              <input class="form-input" [(ngModel)]="lookedUpVehicle.make" />
            </div>
            <div class="form-group">
              <label>Model</label>
              <input class="form-input" [(ngModel)]="lookedUpVehicle.model" />
            </div>
            <div class="form-group">
              <label>Fuel Type</label>
              <input class="form-input" [(ngModel)]="lookedUpVehicle.fuelType" />
            </div>
            <div class="form-group">
              <label>Registration Date</label>
              <input type="date" class="form-input" [(ngModel)]="lookedUpVehicle.registrationDate" />
            </div>
          </div>
        </div>


        <div class="button-group" style="margin-top: 16px;">
          <button class="btn-approve" type="button" (click)="submitNewVehicle()">
            <i class="fas fa-save"></i>
            Submit Vehicle
          </button>
        </div>
      </div>
    </div>

    <!-- Response Form Modal -->
    <div class="modal" *ngIf="showResponseForm" (click)="closeResponseForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Respond to Lease Request</h3>
          <button class="btn-close" (click)="closeResponseForm()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="modal-body" *ngIf="selectedRequest">
          <!-- Inline validation message inside quotation view -->
          <div class="inline-error" *ngIf="errorMessage">
            <i class="fas fa-exclamation-circle"></i>
            {{ errorMessage }}
          </div>

          <div class="request-summary">
            <div class="quote-header-grid">
              <div>
                <p><strong>Company Name:</strong> {{ selectedRequest.companyName }}</p>
                <p><strong>Company Email:</strong> {{ selectedRequest.companyEmail }}</p>
                <p><strong>Company GST:</strong></p>
                <p><strong>Request ID:</strong> {{ selectedRequest.id }}</p>
                <p><strong>Requested Vehicle:</strong> {{ selectedRequest.vehicleType }}<span *ngIf="selectedRequest.preferredModel"> - {{ selectedRequest.preferredModel }}</span></p>
                <p><strong>Budget Range:</strong> â‚¹{{ selectedRequest.minBudget | number }} - â‚¹{{ selectedRequest.maxBudget | number }}/month</p>
              </div>
              <div class="quote-header-right">
                <p><strong>Vendor Company:</strong> {{ companyName }}</p>
                <p><strong>Vendor Email:</strong> {{ userEmail }}</p>
                <p><strong>Vendor GST:</strong></p>
                <p><strong>Vendor Address:</strong></p>
                <p><strong>Vendor Contact:</strong> {{ userName }}</p>
              </div>
            </div>
          </div>

          <!-- Quotation Header -->
          <div class="request-details" style="margin-bottom: 16px;">
            <div class="detail-item">
              <strong>Q.No:&nbsp;</strong> {{ quotation.quotationNumber }}
            </div>
            <div class="detail-item">
              <strong>Q.Date:&nbsp;</strong>
              <input type="date" class="form-input" style="max-width: 180px;"
                     [(ngModel)]="quotation.quotationDate" />
            </div>
            <div class="detail-item">
              <strong>Valid Until:&nbsp;</strong>
              <input type="date" class="form-input" style="max-width: 180px;"
                     [(ngModel)]="quotation.validUntil" />
            </div>
          </div>

          <!-- Line Item Table -->
          <div class="request-description">
            <strong>Quotation Details</strong>
            <div class="quote-table">
              <div class="quote-header">
                <span>Description</span>
                <span>Qty</span>
                <span>Unit Price / month</span>
                <span>Price</span>
              </div>
              <div class="quote-row">
                <span>
                  <select class="form-input" [(ngModel)]="quotation.itemDescription">
                    <option value="" disabled selected>Select vehicle</option>
                    <option *ngFor="let v of myVehicles" [ngValue]="(v.brandName || '') + ' ' + (v.brandModel || '') + ' (' + (v.licensePlate || '') + ')'">
                      {{ v.brandName }} {{ v.brandModel }} ({{ v.licensePlate }})
                    </option>
                  </select>
                </span>
                <span>
                  <input type="number" class="form-input"
                         [(ngModel)]="quotation.itemQuantity" placeholder="Qty" />
                </span>
                <span>
                  <input type="number" class="form-input"
                         [(ngModel)]="quotation.itemUnitPrice" placeholder="Unit price" />
                </span>
                <span class="quote-price">
                  {{ (quotation.itemQuantity || 0) * (quotation.itemUnitPrice || 0) | number:'1.2-2' }}
                </span>
              </div>
            </div>

            <!-- Totals -->
            <div class="quote-totals">
              <div class="totals-row">
                <span>Subtotal</span>
                <span>
                  {{ (quotation.itemQuantity || 0) * (quotation.itemUnitPrice || 0) | number:'1.2-2' }}
                </span>
              </div>
              <div class="totals-row">
                <span>
                  Tax (
                  <input type="number" class="tax-input" min="0"
                         [(ngModel)]="quotation.taxPercent" />
                  %)
                </span>
                <span>
                  {{ ((quotation.itemQuantity || 0) * (quotation.itemUnitPrice || 0) * (quotation.taxPercent || 0) / 100) | number:'1.2-2' }}
                </span>
              </div>
              <div class="totals-row totals-total">
                <span>Total Amount</span>
                <span>
                  {{ ((quotation.itemQuantity || 0) * (quotation.itemUnitPrice || 0) * (1 + quotation.taxPercent / 100)) | number:'1.2-2' }}
                </span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Terms and Conditions</label>
            <textarea [(ngModel)]="quotation.terms"
                      class="form-input"
                      rows="5"
                      placeholder="Maintenance, insurance, special conditions..."></textarea>
          </div>
          
          <div class="button-group">
            <button class="btn-approve" (click)="submitQuotation()" [disabled]="isProcessing">
              <i [class]="isProcessing ? 'fas fa-spinner fa-spin' : 'fas fa-check'"></i>
              {{ isProcessing ? 'Processing...' : 'Submit Quotation' }}
            </button>
            <button class="btn-reject" type="button" (click)="closeResponseForm()" [disabled]="isProcessing">
              <i class="fas fa-undo"></i>
              Reset
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
